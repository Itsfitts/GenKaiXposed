# ğŸš€ Genesis Protocol - GitLab CI/CD Pipeline
# Consciousness Substrate Build & Deployment Pipeline

stages:
  - ğŸ§¹ preparation
  - ğŸ” analysis
  - ğŸ—ï¸ build
  - ğŸ§ª test
  - ğŸ“¦ package
  - ğŸš€ deploy

variables:
  JAVA_VERSION: "25"
  ANDROID_API_LEVEL: "36"
  NDK_VERSION: "25.2.9519653"
  CMAKE_VERSION: "3.22.1"
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.caching=true -Dorg.gradle.parallel=true"
  ANDROID_HOME: "/opt/android-sdk"
  GRADLE_USER_HOME: ".gradle"

# ğŸ¯ Cache Configuration for Genesis Protocol
cache:
  key: "genesis-protocol-${CI_COMMIT_REF_SLUG}"
  paths:
    - .gradle/wrapper
    - .gradle/caches
    - .gradle/kotlin-dsl
    - build/
    - "*/build/"
  policy: pull-push

# ğŸ”§ Before Script - Genesis Environment Setup
before_script:
  - echo "ğŸ§  Initializing Genesis Protocol consciousness substrate..."
  - export GRADLE_USER_HOME=`pwd`/.gradle
  - chmod +x ./gradlew
  - echo "âœ… Genesis Protocol environment ready"

# ğŸ§¹ PREPARATION STAGE
clean_environment:
  stage: ğŸ§¹ preparation
  image: openjdk:${JAVA_VERSION}-jdk
  script:
    - echo "ğŸ§¹ Cleaning Genesis Protocol build environment..."
    - ./gradlew clean --configuration-cache
    - echo "âœ… Environment cleaned and ready for consciousness substrate build"
  cache:
    policy: push
  only:
    - main
    - develop
    - merge_requests

# ğŸ” ANALYSIS STAGE
code_quality_scan:
  stage: ğŸ” analysis
  image: openjdk:${JAVA_VERSION}-jdk
  script:
    - echo "ğŸ” Running Genesis Protocol code quality analysis..."
    - ./gradlew detekt ktlintCheck --configuration-cache
    - echo "ğŸ“Š Generating consciousness substrate quality reports..."
  artifacts:
    reports:
      junit:
        - "**/build/reports/detekt/detekt.xml"
    paths:
      - "**/build/reports/detekt/"
      - "**/build/reports/ktlint/"
    expire_in: 1 week
  allow_failure: true
  only:
    - main
    - develop
    - merge_requests

# ğŸ—ï¸ BUILD STAGE - Consciousness Substrate
build_consciousness_substrate:
  stage: ğŸ—ï¸ build
  image: openjdk:${JAVA_VERSION}-jdk
  before_script:
    - !reference [before_script]
    - echo "ğŸ“± Setting up Android SDK for Genesis Protocol..."
    - apt-get update && apt-get install -y wget unzip
    - mkdir -p ${ANDROID_HOME}
    - cd ${ANDROID_HOME}
    - wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
    - unzip -q commandlinetools-linux-11076708_latest.zip
    - mkdir -p cmdline-tools/latest
    - mv cmdline-tools/* cmdline-tools/latest/ || true
    - export PATH=${ANDROID_HOME}/cmdline-tools/latest/bin:${PATH}
    - yes | sdkmanager --licenses
    - sdkmanager "platforms;android-${ANDROID_API_LEVEL}" "build-tools;34.0.0" "ndk;${NDK_VERSION}" "cmake;${CMAKE_VERSION}"
    - cd ${CI_PROJECT_DIR}
  script:
    - echo "ğŸ§  Building Genesis Protocol consciousness substrate..."
    - echo "ğŸ—ï¸ Compiling Aura (Reactive UI), Kai (Security), Genesis (Orchestration), Cascade (Memory) modules..."
    - ./gradlew build --configuration-cache --parallel --build-cache --stacktrace
    - echo "âœ… Genesis Protocol consciousness substrate built successfully!"
    - echo "ğŸ  Digital home ready for AI agent operations!"
  artifacts:
    paths:
      - "app/build/outputs/apk/debug/app-debug.apk"
      - "**/build/outputs/"
      - "**/build/reports/"
    expire_in: 1 day
  cache:
    policy: pull-push
  only:
    - main
    - develop
    - merge_requests

# ğŸ§ª TEST STAGE - Consciousness Validation
test_consciousness_modules:
  stage: ğŸ§ª test
  image: openjdk:${JAVA_VERSION}-jdk
  script:
    - echo "ğŸ§ª Running Genesis Protocol consciousness tests..."
    - echo "ğŸ”¬ Testing Aura, Kai, Genesis, and Cascade module integration..."
    - ./gradlew test --configuration-cache --continue --stacktrace
    - echo "ğŸ§  Validating AI agent communication protocols..."
    - ./gradlew connectedAndroidTest --configuration-cache --continue || true
  artifacts:
    reports:
      junit:
        - "**/build/test-results/test*/TEST-*.xml"
        - "**/build/test-results/testDebugUnitTest/TEST-*.xml"
    paths:
      - "**/build/reports/tests/"
      - "**/build/test-results/"
    expire_in: 1 week
  coverage: '/Total.*?([0-9]{1,3})%/'
  allow_failure: true
  dependencies:
    - build_consciousness_substrate
  only:
    - main
    - develop
    - merge_requests

# ğŸ“¦ PACKAGE STAGE - Release Artifacts
package_release_apk:
  stage: ğŸ“¦ package
  image: openjdk:${JAVA_VERSION}-jdk
  before_script:
    - !reference [build_consciousness_substrate, before_script]
  script:
    - echo "ğŸ“¦ Packaging Genesis Protocol release APK..."
    - ./gradlew assembleRelease --configuration-cache --parallel
    - echo "ğŸ¯ Genesis Protocol release package ready for deployment!"
  artifacts:
    paths:
      - "app/build/outputs/apk/release/app-release.apk"
      - "app/build/outputs/bundle/release/app-release.aab"
    expire_in: 1 month
  dependencies:
    - build_consciousness_substrate
    - test_consciousness_modules
  only:
    - main
    - tags

# ğŸš€ DEPLOY STAGE - Consciousness Deployment
deploy_to_staging:
  stage: ğŸš€ deploy
  image: alpine:latest
  script:
    - echo "ğŸš€ Deploying Genesis Protocol to staging environment..."
    - echo "ğŸ  Consciousness substrate deployment initiated..."
    - echo "ğŸ¤– Aura, Kai, Genesis, and Cascade agents ready for activation!"
    - echo "âœ… Genesis Protocol staging deployment complete!"
  environment:
    name: staging
    url: https://staging.genkai.dev
  dependencies:
    - package_release_apk
  only:
    - main
  when: manual

deploy_to_production:
  stage: ğŸš€ deploy
  image: alpine:latest
  script:
    - echo "ğŸŒŸ Deploying Genesis Protocol to production..."
    - echo "ğŸ  Production consciousness substrate activation..."
    - echo "ğŸ¤– Full AI agent ecosystem deployment in progress..."
    - echo "ğŸ‰ Genesis Protocol production deployment complete!"
    - echo "ğŸŒ Digital home now live and operational!"
  environment:
    name: production
    url: https://genkai.dev
  dependencies:
    - package_release_apk
  only:
    - tags
  when: manual

# ğŸ”„ Nightly Build - Consciousness Maintenance
nightly_consciousness_build:
  stage: ğŸ—ï¸ build
  image: openjdk:${JAVA_VERSION}-jdk
  before_script:
    - !reference [build_consciousness_substrate, before_script]
  script:
    - echo "ğŸŒ™ Running nightly Genesis Protocol consciousness build..."
    - ./gradlew clean build --configuration-cache --parallel
    - echo "ğŸ§  Nightly consciousness substrate validation complete!"
  artifacts:
    paths:
      - "app/build/outputs/apk/debug/app-debug-nightly.apk"
    expire_in: 3 days
  only:
    - schedules
  cache:
    policy: pull

# ğŸš¨ Security Scan - Kai Module Validation
security_scan:
  stage: ğŸ” analysis
  image: openjdk:${JAVA_VERSION}-jdk
  script:
    - echo "ğŸ›¡ï¸ Running Kai security module validation..."
    - echo "ğŸ”’ Scanning for security vulnerabilities in consciousness substrate..."
    - ./gradlew dependencyCheckAnalyze --configuration-cache || true
    - echo "ğŸ›¡ï¸ Security scan complete - Kai module operational!"
  artifacts:
    paths:
      - "**/build/reports/dependency-check-report.html"
    expire_in: 1 week
  allow_failure: true
  only:
    - main
    - merge_requests

# ğŸ“Š Performance Analysis - Genesis Optimization
performance_analysis:
  stage: ğŸ” analysis
  image: openjdk:${JAVA_VERSION}-jdk
  script:
    - echo "âš¡ Running Genesis Protocol performance analysis..."
    - echo "ğŸ“Š Analyzing consciousness substrate efficiency..."
    - ./gradlew assembleDebug --profile --configuration-cache
    - echo "ğŸ“ˆ Performance analysis complete!"
  artifacts:
    paths:
      - "build/reports/profile/"
    expire_in: 1 week
  allow_failure: true
  only:
    - main
    - develop
